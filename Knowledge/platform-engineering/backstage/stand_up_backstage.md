# Backstage環境構築

- AWS EC2のAmazon Linuxを使用したを用いてたBackstageの環境構築方法を記載

## 事前準備

### EC2インスタンスの作成

1. 下記の項目に従ってEC2インスタンスを作成する

   | 項目                                               | 値                                                                                                                                                                                                                                                       | 備考                                                                                           |
   |--------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------|
   | 名前とタグ                                            | 任意の名前を指定                                                                                                                                                                                                                                                | ー                                                                                            |
   | Application and OS Images (Amazon Machine Image) | Red Hat Enterprise Linux 9 (HVM), SSD Volume Type                                                                                                                                                                                                       | ー                                                                                            |
   | インスタンスタイプ                                        | t2.small                                                                                                                                                                                                                                                | ー                                                                                            |
   | キーペア (ログイン)                                      | 自分用のキーペアを指定                                                                                                                                                                                                                                             | 今回はED25519でプライベートキーとパブリックキーを生成                                                               |
   | ネットワーク設定                                         | ・ネットワーク: デフォルト ※1<br/>・サブネット: 先順位なし (アベイラビリティーゾーンのデフォルトサブネット)<br/>・パブリック IP の自動割り当て: 有効化<br/>・ファイアウォール (セキュリティグループ): セキュリティグループを作成 ※2<br/>・Allow SSH traffic from: true ※3<br/>・インターネットからの HTTPS トラフィックを許可: false<br/>・インターネットからの HTTP トラフィックを許可: false | ※1: デフォルトで自動割り当てされる<br/>※2: 自分のIPからSSH接続が可能になるように設定<br/>※3: traficはデフォルトでOK(デフォルトは0.0.0.0/0) |
   | ストレージを設定                                         | 30GiB                                                                                                                                                                                                                                                  | ー                                                                                            |

2. 作成したインスタンスが下記内容の通りに立ち上げられていることを確認する
   - セキュリティのインバウンドグループが設定されていること
   - パブリックIPが自動割り当てされないこと 

> SSH (ポート22) ,HTTP (ポート80) ポート3000,を許可の内容を追加

### Elastic IPの設定

1. EC2ホーム画面のサイドバーにある`ネットワーク&セキュリティ`から`Elastic IP`をクリック
2. `Elastic IPアドレスを割り当てる`をクリックしてElastic IPの作成画面に移る
3. 下記を項目を設定の後`割り当て`を実行

   | 項目               | 値                                     | 備考                             |
   |------------------|---------------------------------------|--------------------------------|
   | ネットワークボーダーグループ   | デフォルト                                 | ー                              |
   | パブリックIPv4アドレスプール | デフォルト                                 | ー                              |
   | タグ               | key = `please`, value = `do_not_stop` | 該当tagを使用すると、インスタンスが自動削除の対象外となる |

4. アクションを選択して、Elastic IPの関連付けをクリック
5. 下記設定して割り当てして関連付けるをクリック

   | 項目       | 値                              | 備考 |
   |----------|--------------------------------|----|
   | リソースタイプ  | インスタンス                         | ー  |
   | インスタンス   | 作成したインスタンス名を検索して選択             | ー  |
   | プライベートIP | おすすめされたものを選択(自分で作成したEC2インスタンス) | ー  |

6. 作成したEC2インスタンスのパブリックIPv4アドレスとElastic IPアドレスが一致していることを確認する

### 作成したインスタンスに接続

1. vscodeのconfigにインスタンスを登録
2. SSH接続を実施する
3. yum updateを実施
   - システムのパッケージを最新の状態に更新します。

     ```terminal
     $ sudo yum update -y
     ```

4. Node.jsのインストール
   - Node.jsをインストールします。Node.jsはBackstageの動作に必要です。

     ```terminal
     $ curl -sL https://rpm.nodesource.com/setup_20.x | sudo bash -
     $ sudo yum install -y nodejs
     ```

> 適応バージョンはBackstageの要求バージョンは要確認  
> バージョンの変更が必要な場合は`setup_20.x`の部分を変更する

5. 現在のNode.jsバージョンを確認
   - 今回のケースではバージョン20以上であることを確認する

     ```terminal
     $ node -v
     ```

6. Yarnのインストール
   -  Yarnをインストールします。Yarnはパッケージマネージャーで、Backstageの依存関係を管理します。

      ```terminal
      $ sudo npm install -g yarn
      ```

7. gitのインストールを実施する
   -  Gitをインストールします。Gitはバージョン管理システムで、ソースコードの管理に使用します。

      ```terminal
      $ sudo yum install -y git
      ```

8. dockerのインストールを実施する
   - dockerのインストールを実施します

      ```terminal
      $ sudo yum install  -y docker
      ```

9.  git cloneを実行する

   ```terminal
   $ git clone https://github.com/ap-communications/chocott-backstage.git --depth 1
   ```

### Backstage環境のセットアップ

1. Backstageアプリケーションの作成
   - Backstageアプリケーションを作成します。npxはnpmのツールで、一時的にパッケージを実行します。
   - プロンプトに従ってアプリケーション名を入力します（例: my-backstage-app）。

      ```terminal
      $ npx @backstage/create-app@latest
      ```

     > 作成には数分かかります  
     > yarn installがうまくいかない場合は、以下のコマンドで、npmのグローバルディレクトリのパーミッションを修正します。

      ```
      sudo chown -R $(whoami) $(npm config get prefix)/{libnode_modules,bin,share}
      ```

2. 作成されたディレクトリに移動します。
   - 作成されたディレクトリに移動します。

      ```terminal
      $ cd my-backstage-app
      ```

3. 依存関係のインストール
   - Backstageアプリケーションの依存関係をインストールします。

      ```terminal
      $ yarn install
      ```
